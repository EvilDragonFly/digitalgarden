---
dg-publish: true
---
![paul-pastourmatzis-hKOPVtGQZ4o-unsplash.jpg|100%](/img/user/banner/paul-pastourmatzis-hKOPVtGQZ4o-unsplash.jpg)
reference articles:
https://www.intel.com/content/www/us/en/developer/articles/technical/performance-tuning-of-ceph-rbd.html
https://www.youtube.com/watch?v=UjpaZ-JH4Yo

![Pasted image 20231019002305.png](/img/user/pics/Pasted%20image%2020231019002305.png)

## Ceph Cluster Components
<style> .container {font-family: sans-serif; text-align: center;} .button-wrapper button {z-index: 1;height: 40px; width: 100px; margin: 10px;padding: 5px;} .excalidraw .App-menu_top .buttonList { display: flex;} .excalidraw-wrapper { height: 800px; margin: 50px; position: relative;} :root[dir="ltr"] .excalidraw .layer-ui__wrapper .zen-mode-transition.App-menu_bottom--transition-left {transform: none;} </style><script src="https://cdn.jsdelivr.net/npm/react@17/umd/react.production.min.js"></script><script src="https://cdn.jsdelivr.net/npm/react-dom@17/umd/react-dom.production.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@excalidraw/excalidraw@0/dist/excalidraw.production.min.js"></script><div id="Drawing_2023-10-19_1237.02.excalidraw.md1"></div><script>(function(){const InitialData={"type":"excalidraw","version":2,"source":"https://github.com/zsviczian/obsidian-excalidraw-plugin/releases/tag/1.9.19","elements":[{"id":"PLWM80RJVP7Kmw8cXhYM_","type":"rectangle","x":-296.66796875,"y":-115.12109375,"width":73,"height":35,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"roundness":{"type":3},"seed":235242497,"version":124,"versionNonce":20685519,"isDeleted":false,"boundElements":[{"type":"text","id":"JMQzVJ8M"}],"updated":1697690462616,"link":null,"locked":false},{"id":"JMQzVJ8M","type":"text","x":-286.7379455566406,"y":-110.12109375,"width":53.13995361328125,"height":25,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"roundness":null,"seed":1349949729,"version":77,"versionNonce":2078274977,"isDeleted":false,"boundElements":null,"updated":1697690462616,"link":null,"locked":false,"text":"OSDs","rawText":"OSDs","fontSize":20,"fontFamily":1,"textAlign":"center","verticalAlign":"middle","baseline":18,"containerId":"PLWM80RJVP7Kmw8cXhYM_","originalText":"OSDs","lineHeight":1.25},{"id":"igsJk3CLAlnLUztxXm3Zi","type":"rectangle","x":-195.810546875,"y":-129.76171875,"width":100,"height":60,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"roundness":{"type":3},"seed":1895496705,"version":223,"versionNonce":712798447,"isDeleted":false,"boundElements":[{"type":"text","id":"NED06pch"}],"updated":1697690462616,"link":null,"locked":false},{"id":"NED06pch","type":"text","x":-186.7905044555664,"y":-112.26171875,"width":81.95991516113281,"height":25,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"roundness":null,"seed":1239566721,"version":244,"versionNonce":510826881,"isDeleted":false,"boundElements":null,"updated":1697690462616,"link":null,"locked":false,"text":"Monitors","rawText":"Monitors","fontSize":20,"fontFamily":1,"textAlign":"center","verticalAlign":"middle","baseline":18,"containerId":"igsJk3CLAlnLUztxXm3Zi","originalText":"Monitors","lineHeight":1.25},{"id":"S5X0gM19pqbnVF95Q0nQA","type":"rectangle","x":-65.037109375,"y":-122.73828125,"width":104,"height":60,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"roundness":{"type":3},"seed":1606923087,"version":136,"versionNonce":717126415,"isDeleted":false,"boundElements":[{"type":"text","id":"P6a5jzxe"}],"updated":1697690462616,"link":null,"locked":false},{"id":"P6a5jzxe","type":"text","x":-58.917076110839844,"y":-105.23828125,"width":91.75993347167969,"height":25,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"roundness":null,"seed":799780879,"version":157,"versionNonce":1120256353,"isDeleted":false,"boundElements":null,"updated":1697690462616,"link":null,"locked":false,"text":"Managers","rawText":"Managers","fontSize":20,"fontFamily":1,"textAlign":"center","verticalAlign":"middle","baseline":18,"containerId":"S5X0gM19pqbnVF95Q0nQA","originalText":"Managers","lineHeight":1.25},{"id":"bmMLTJ9M-vRZnLzoT0bbN","type":"rectangle","x":67.544921875,"y":-116.140625,"width":76,"height":41,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"roundness":{"type":3},"seed":1346723777,"version":230,"versionNonce":108675375,"isDeleted":false,"boundElements":[{"type":"text","id":"YALHS840"}],"updated":1697690462616,"link":null,"locked":false},{"id":"YALHS840","type":"text","x":84.65493774414062,"y":-108.140625,"width":41.77996826171875,"height":25,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"roundness":null,"seed":1630927713,"version":102,"versionNonce":1713958209,"isDeleted":false,"boundElements":null,"updated":1697690462616,"link":null,"locked":false,"text":"MDs","rawText":"MDs","fontSize":20,"fontFamily":1,"textAlign":"center","verticalAlign":"middle","baseline":18,"containerId":"bmMLTJ9M-vRZnLzoT0bbN","originalText":"MDs","lineHeight":1.25},{"id":"cwFG09sSKi0StA_pTQCbP","type":"ellipse","x":-320.63671875,"y":-225.83984375,"width":505.2265625,"height":276.9921875,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"roundness":{"type":2},"seed":530716527,"version":135,"versionNonce":521683791,"isDeleted":false,"boundElements":null,"updated":1697690462616,"link":null,"locked":false},{"id":"i5fzhWux","type":"text","x":-104.359375,"y":-203.80078125,"width":69.52935791015625,"height":42.695312500000014,"angle":0,"strokeColor":"#2f9e44","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"roundness":null,"seed":39753455,"version":127,"versionNonce":822300527,"isDeleted":false,"boundElements":null,"updated":1697691448723,"link":null,"locked":false,"text":"ceph","rawText":"ceph","fontSize":34.156250000000014,"fontFamily":1,"textAlign":"left","verticalAlign":"top","baseline":30,"containerId":null,"originalText":"ceph","lineHeight":1.25},{"id":"E5YMKldG","type":"text","x":-104.75,"y":-108.9375,"width":10,"height":25,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"roundness":null,"seed":775003695,"version":15,"versionNonce":164517313,"isDeleted":true,"boundElements":null,"updated":1697690462616,"link":null,"locked":false,"text":"","rawText":"","fontSize":20,"fontFamily":1,"textAlign":"left","verticalAlign":"top","baseline":18,"containerId":null,"originalText":"","lineHeight":1.25},{"id":"iH7imlcM","type":"text","x":-40.75,"y":-200.9375,"width":10,"height":25,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"roundness":null,"seed":777424289,"version":15,"versionNonce":351338863,"isDeleted":true,"boundElements":null,"updated":1697690462616,"link":null,"locked":false,"text":"","rawText":"","fontSize":20,"fontFamily":1,"textAlign":"left","verticalAlign":"top","baseline":18,"containerId":null,"originalText":"","lineHeight":1.25},{"id":"mhiI8kePT7Ao-yyJ1SQgl","type":"freedraw","x":-76.58203125,"y":-195.96875,"width":0.0001,"height":0.0001,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"roundness":null,"seed":216370895,"version":16,"versionNonce":799887617,"isDeleted":true,"boundElements":null,"updated":1697690462616,"link":null,"locked":false,"points":[[0,0],[0.0001,0.0001]],"pressures":[],"simulatePressure":true,"lastCommittedPoint":[0.0001,0.0001]},{"id":"Kd-F5DamDPnkCpOmB-7wG","type":"freedraw","x":-76.58203125,"y":-195.96875,"width":0.0001,"height":0.0001,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"roundness":null,"seed":517713199,"version":15,"versionNonce":1695431137,"isDeleted":true,"boundElements":null,"updated":1697690461823,"link":null,"locked":false,"points":[[0,0],[0.0001,0.0001]],"pressures":[],"simulatePressure":true,"lastCommittedPoint":[0.0001,0.0001]},{"id":"fec-FaLniKEoA1zAQkfuD","type":"freedraw","x":-60.51953125,"y":-195.96875,"width":0.0001,"height":0.0001,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"roundness":null,"seed":1603659663,"version":14,"versionNonce":1032941487,"isDeleted":true,"boundElements":null,"updated":1697690460967,"link":null,"locked":false,"points":[[0,0],[0.0001,0.0001]],"pressures":[],"simulatePressure":true,"lastCommittedPoint":[0.0001,0.0001]},{"id":"LcDqjdj_7diuUhOul80Jg","type":"freedraw","x":-60.51953125,"y":-195.96875,"width":0.0001,"height":0.0001,"angle":0,"strokeColor":"#1e1e1e","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"roundness":null,"seed":364494319,"version":13,"versionNonce":666783407,"isDeleted":true,"boundElements":null,"updated":1697690460228,"link":null,"locked":false,"points":[[0,0],[0.0001,0.0001]],"pressures":[],"simulatePressure":true,"lastCommittedPoint":[0.0001,0.0001]},{"id":"9NsJ4XADCngjBeaSNIPxV","type":"freedraw","x":-70.80859375,"y":-194.54296875,"width":0.0001,"height":0.0001,"angle":0,"strokeColor":"#2f9e44","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"roundness":null,"seed":1170243617,"version":12,"versionNonce":1359367393,"isDeleted":true,"boundElements":null,"updated":1697690459455,"link":null,"locked":false,"points":[[0,0],[0.0001,0.0001]],"pressures":[],"simulatePressure":true,"lastCommittedPoint":[0.0001,0.0001]},{"id":"kEO-ehrfnnvC-zWXZDRlO","type":"freedraw","x":-70.80859375,"y":-194.54296875,"width":0.0001,"height":0.0001,"angle":0,"strokeColor":"#2f9e44","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"roundness":null,"seed":1441236929,"version":11,"versionNonce":1477797377,"isDeleted":true,"boundElements":null,"updated":1697690458735,"link":null,"locked":false,"points":[[0,0],[0.0001,0.0001]],"pressures":[],"simulatePressure":true,"lastCommittedPoint":[0.0001,0.0001]},{"id":"rsH3r6qE3fZ67HgB1ozvb","type":"freedraw","x":-70.80859375,"y":-194.54296875,"width":0.0001,"height":0.0001,"angle":0,"strokeColor":"#2f9e44","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"roundness":null,"seed":1582576481,"version":9,"versionNonce":1719642543,"isDeleted":true,"boundElements":null,"updated":1697690455276,"link":null,"locked":false,"points":[[0,0],[0.0001,0.0001]],"pressures":[],"simulatePressure":true,"lastCommittedPoint":[0.0001,0.0001]},{"id":"WEzm2I8gvKpUP4s7cmUam","type":"freedraw","x":-70.80859375,"y":-194.54296875,"width":0.0001,"height":0.0001,"angle":0,"strokeColor":"#2f9e44","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"roundness":null,"seed":398000897,"version":8,"versionNonce":1800181871,"isDeleted":true,"boundElements":null,"updated":1697690454641,"link":null,"locked":false,"points":[[0,0],[0.0001,0.0001]],"pressures":[],"simulatePressure":true,"lastCommittedPoint":[0.0001,0.0001]},{"id":"mYQqK0ffyVl4QABv4VYg2","type":"freedraw","x":-70.80859375,"y":-194.54296875,"width":0.0001,"height":0.0001,"angle":0,"strokeColor":"#2f9e44","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"roundness":null,"seed":702052001,"version":7,"versionNonce":1717480289,"isDeleted":true,"boundElements":null,"updated":1697690453907,"link":null,"locked":false,"points":[[0,0],[0.0001,0.0001]],"pressures":[],"simulatePressure":true,"lastCommittedPoint":[0.0001,0.0001]},{"id":"jZwtHsJXaw_cxA6e2BMMz","type":"freedraw","x":-61.41796875,"y":-195.38671875,"width":0.0001,"height":0.0001,"angle":0,"strokeColor":"#2f9e44","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"roundness":null,"seed":1166347841,"version":6,"versionNonce":110923969,"isDeleted":true,"boundElements":null,"updated":1697690453230,"link":null,"locked":false,"points":[[0,0],[0.0001,0.0001]],"pressures":[],"simulatePressure":true,"lastCommittedPoint":[0.0001,0.0001]},{"id":"XxtIcpKY3uDOmqZB-dy4o","type":"freedraw","x":-23.984375,"y":-186.73828125,"width":0.0001,"height":0.0001,"angle":0,"strokeColor":"#2f9e44","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"roundness":null,"seed":2124499425,"version":5,"versionNonce":1675277903,"isDeleted":true,"boundElements":null,"updated":1697690452536,"link":null,"locked":false,"points":[[0,0],[0.0001,0.0001]],"pressures":[],"simulatePressure":true,"lastCommittedPoint":[0.0001,0.0001]},{"id":"HVC1IhULA-xSHy0IcgGty","type":"freedraw","x":-76.48046875,"y":259.0546875,"width":0.0001,"height":0.0001,"angle":0,"strokeColor":"#2f9e44","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"roundness":null,"seed":1713351041,"version":4,"versionNonce":1350341839,"isDeleted":true,"boundElements":null,"updated":1697690450910,"link":null,"locked":false,"points":[[0,0],[0.0001,0.0001]],"pressures":[],"simulatePressure":true,"lastCommittedPoint":[0.0001,0.0001]},{"id":"ty8BbejP_DNFYkEvpgaAQ","type":"freedraw","x":-268.23828125,"y":250.40234375,"width":0.0001,"height":0.0001,"angle":0,"strokeColor":"#2f9e44","backgroundColor":"transparent","fillStyle":"hachure","strokeWidth":1,"strokeStyle":"solid","roughness":1,"opacity":100,"groupIds":[],"frameId":null,"roundness":null,"seed":459054031,"version":4,"versionNonce":80231759,"isDeleted":true,"boundElements":null,"updated":1697690458069,"link":null,"locked":false,"points":[[0,0],[0.0001,0.0001]],"pressures":[],"simulatePressure":true,"lastCommittedPoint":[0.0001,0.0001]}],"appState":{"theme":"light","viewBackgroundColor":"#ffffff","currentItemStrokeColor":"#2f9e44","currentItemBackgroundColor":"transparent","currentItemFillStyle":"hachure","currentItemStrokeWidth":1,"currentItemStrokeStyle":"solid","currentItemRoughness":1,"currentItemOpacity":100,"currentItemFontFamily":1,"currentItemFontSize":20,"currentItemTextAlign":"left","currentItemStartArrowhead":null,"currentItemEndArrowhead":"arrow","scrollX":417.25,"scrollY":436.0625,"zoom":{"value":1},"currentItemRoundness":"round","gridSize":null,"gridColor":{"Bold":"#C9C9C9FF","Regular":"#EDEDEDFF"},"currentStrokeOptions":null,"previousGridSize":null,"frameRendering":{"enabled":true,"clip":true,"name":true,"outline":true}},"files":{}};InitialData.scrollToContent=true;App=()=>{const e=React.useRef(null),t=React.useRef(null),[n,i]=React.useState({width:void 0,height:void 0});return React.useEffect(()=>{i({width:t.current.getBoundingClientRect().width,height:t.current.getBoundingClientRect().height});const e=()=>{i({width:t.current.getBoundingClientRect().width,height:t.current.getBoundingClientRect().height})};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[t]),React.createElement(React.Fragment,null,React.createElement("div",{className:"excalidraw-wrapper",ref:t},React.createElement(ExcalidrawLib.Excalidraw,{ref:e,width:n.width,height:n.height,initialData:InitialData,viewModeEnabled:!0,zenModeEnabled:!0,gridModeEnabled:!1})))},excalidrawWrapper=document.getElementById("Drawing_2023-10-19_1237.02.excalidraw.md1");ReactDOM.render(React.createElement(App),excalidrawWrapper);})();</script>
- ceph monitor maintains a master copy of the cluster copy of the cluster map. A cluster of cpeh monitors ensures high availability when a monitor daemon fail. Storage cluster clients retrieve a copy of the cluster map from the Ceph monitor.
- A ceph osd daemon checks its own state and the state of the other osds and reports back to monitors
- A ceph manager acts as an endpoint for monitoring, orchestration, and plug-in modules.
- A Ceph Metadata Server managers file metadata when CephFs is used to provide file services.
## osds storing data
- ceph osd daemons存储数据作为objects以一个flat namespace(没有层级目录)，一个object含有一个identifier，binary data和包含一系列的name/value pair的metadata
- 数据和元数据使用bluestore,memorystore和seastore(在开发完善中)存储
- 元数据默认使用rocksdb(bluestore没有自己的元数据管理程序)存储，单独一个分区来存储元数据可以提升性能

Mapping PGs to OSDs
- 客户端存储objects时，crush会将objects map到PG上
- 每一个pool有一些pgs， crush会动态的将pgs map到osds

## client-RBD IO Layer
逐层下发

ImageDispatchLayer
ObjectDispatchLayer

## Threads Model
![Pasted image 20231019002342.png|100%](/img/user/pics/Pasted%20image%2020231019002342.png)

## Librados/librbd Call Example
- FIO example
- 1. r = rados_create(&rbd->cluster,o->client_name);
- 2. r = rados_connect(rbd->cluster);
- 3. r = rados_ioctx_create(rbd->cluster, o->pool_name,&rbd->io_ctx);
- 4. r = rbd_open(rbd->io_ctx, o->rbd_name, &rbd->image, NULL/*snap*/);
- 5. read, write, flush

- unshared rados: 1->2->3->4->1->2->3->4
- shared rados: 1->2->3->4->3->4


## SPDK RBD bdev
![Pasted image 20231019131329.png|100%](/img/user/pics/Pasted%20image%2020231019131329.png)

Call stack of unshared threads

![Pasted image 20231019131348.png|100%](/img/user/pics/Pasted%20image%2020231019131348.png)
Call stack of shared threads